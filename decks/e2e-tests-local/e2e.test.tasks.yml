version: '3'

vars:
  _repo_root_: "$(realpath ../..)"

tasks:

  ci-flow:
    desc: _
    cmds:
      - task: resolve-dimgs
      - task: test-all-clean
      - task stop

  resolve-dimgs:
    desc: _
    deps:
      - task: build-jenconda
      - task: build-dev-editor
    cmds:
      - echo "resolved jenconda,dev-editor"
  # === tests section ===

  build-jenconda: |-
    task -d {{._repo_root_}}/dockers/jenkins-master docker:build:jenconda

  build-dev-editor: |-
    task -d {{._repo_root_}}/decks/dev-editor-local build

  # === tests section ===
  # --- top-level stages ---
  test-all-clean:
    desc: _
    cmds:
      - task renew
      - task: test-all
      # - task -d dockers/jendev stop

  test-all:
    desc: run all test sets in parallel
    deps:
      - task: test-new-ci-bootstrap
      - task: test-plain-groovy-in-jup
    cmds:
      - echo ok
  # --- steps ---

  test-plain-groovy-in-docker:
    desc: run plain groovy tests in docker
    cmds:
      - docker run --rm -v {{._repo_root_}}:/repo --workdir /repo jupconda_img task -d src test

  test-plain-groovy-in-jup:
    desc: run plain groovy tests in jupyter
    cmds:
      - docker-compose exec  jupcondadev.samexample.com task -d /home/jovyan/repo/src test

  test-new-ci-bootstrap:
    desc: use jenpy cli to trigger builds
    cmds:
      - sleep 15
      - docker-compose exec  jupcondadev.samexample.com python /home/jovyan/repo/jenpy/jenpy_cli.py test_bootstrap
  # /=== tests section ===
