# https://taskfile.dev

version: '3'

vars:
  # --- Tasker Variables ---
  DIMAGE: local-docs-dimg
  conda_env_name: local-docs-env

  # --- Docker File Part Blocks ---
  __dbuild_s000_header: |-
    FROM continuumio/miniconda3

  __dbuild_s011_setup_deps_apt: |-
    RUN apt update -y && apt install -y curl git

  __dbuild_s013_setup_deps_task: |-
    # https://taskfile.dev/#/installation?id=get-the-binary
    RUN sh -c "\$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

  __dbuild_s017_setup_deps: |-
    COPY deps.setup.conda-env.exe.yml /deps/deps.setup.conda-env.exe.yml
    RUN task install -t /deps/deps.setup.conda-env.exe.yml
    ENV PATH /opt/conda/envs/{{.conda_env_name}}/bin:\$PATH
    RUN bash -c "source activate {{.conda_env_name}}"
    ENV CONDA_DEFAULT_ENV {{.conda_env_name}}


  __dbuild_s017_setup_deps__test_e01: |-
    RUN mkdocs --version

  __dbuild_dockerfile_content: |-
    {{.__dbuild_s000_header}}
    {{.__dbuild_s011_setup_deps_apt}}
    {{.__dbuild_s013_setup_deps_task}}
    {{.__dbuild_s017_setup_deps}}
    {{.__dbuild_s017_setup_deps__test_e01}}
  

tasks:
  default:
    cmds:
      - task -l
    silent: true

  gen-dockerfile:
    desc: generates dockerfile from parts
    cmds:
      - |-
        cat <<EOF > Dockerfile
        {{.__dbuild_dockerfile_content}}
        EOF
        cat Dockerfile
    source:
      - Taskfile.yml
    generates:
      - Dockerfile
  
  build:
    desc: build docker
    deps:
      - task: gen-dockerfile
    cmds:
      - docker build -t {{.DIMAGE}} .



